<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{dataset}} Reports Dashboard</title>
    <meta name="description" content="{{dataset}} Reports Dashboard">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/widget.grouping.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.bootstrap_4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <style type="text/css">
      a {text-decoration: none;}
      .group-name {font-weight: normal;}
      .description {
            text-align: center;
            display: block;
            margin: auto;
        }
        .container {
            max-width: 80vw;
            display: block;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loci-cell {
            filter: blur(5px) grayscale(100%);
            cursor: pointer;
            transition: filter 0.3s ease;
        }
        .loci-cell.revealed {
            filter: none;
        }

    </style>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-dark justify-content-start">
      <a class="navbar-brand p-3" href="#">{{dataset}} Reports Dashboard</a>
    </nav>

    <div class="container">
        <div class="description">
            <p>Explore STRipy reports organised by Sample and Family IDs, Report Type, and Missing Loci.</p>
            <p>Click "Open" to view individual detailed reports</p>
            <p> Note: The "Missing loci" column shows loci present in the panel for the given Report Type, but absent from
            the variant data for a sample. This can happen when a sample was processed before a locus was added to the
            STRipy catalogue. These samples can be re-genotyped on request, which will capture all current loci.
            </p>
        </div>

        <div style="text-align: center;">
            <button id="toggleButton" onclick="toggleTableVisibility()" style="background-color: #90EE90; border: none; border-radius: 8px; padding: 8px 16px;">
                Show Report Loci Reference Table
            </button>
        </div>

        <br>

        <div id="lociTableContainer" style="display: none;">
            <table class="table tablesorter" id="loci-table">
                <thead>
                    <tr>
                        <th>Report Type</th>
                        <th>Total Loci</th>
                        <th>Full Loci List</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Default</strong></td>
                        <td>62</td>
                        <td>ABCD3, AFF2, AR, ARX_1, ARX_2, ATN1, ATXN1, ATXN10, ATXN2, ATXN3, ATXN7, ATXN8OS, BEAN1, C9ORF72, CACNA1A, CBL, CNBP, COMP, CSTB, DAB1, DIP2B, DMD, DMPK, EIF4A3, FGF14, FMR1, FOXL2, FXN, GIPC1, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, HTT, JPH3, LRP12, MARCHF6, NOP56, NOTCH2NLC, NUTM2B-AS1, PABPN1, PHOX2B, PPP2R2B, PRDM12, PRNP, RAPGEF2, RILPL1, RUNX2, SAMD12, SOX3, STARD7, TBP, TBX1, TCF4, THAP11, TNRC6A, VWA1, XYLT1, YEATS2, ZFHX3, ZIC2, ZIC3</td>
                    </tr>
                    <tr>
                        <td><strong>Default with exclusions</strong></td>
                        <td>59</td>
                       <td>The same list as default, but excludes C9ORF72, HTT, and PRNP</td>
                    </tr>

                    <tr>
                        <td><strong>Paediatric</strong></td>
                        <td>31</td>
                        <td>AFF2, ARX_2, ATXN2, ATXN3, ATXN7, CBL, COMP, CSTB, DIP2B, DMD, DMPK, EIF4A3, FMR1, FOXL2, FXN, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, PHOX2B, PPP2R2B, PRDM12, RUNX2, SOX3, TBP, TBX1, VWA1, XYLT1, ZIC2, ZIC3</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <main class="container mt-4 mb-4">

    <div class="tab-pane fade show active" id="results-tab-pane" role="tabpanel" tabindex="0">
        <table class="table tablesorter" id="report-table">
            <thead>
                <tr>
                <th class="group-false">Sample</th>
                <th class="group-false">Family</th>
                <th class="group-false">Ext.ID</th>
                <th class="group-false">Ext.Sample</th>
                <th class="group-false">Report Type</th>
                <th class="group-false sorter-shortDate" data-date-format="yyyy-mm-dd">Date</th>
                <th class="group-false">Missing Loci</th>
                <th class="group-false">Loci of Interest</th>
                <th class="group-false">Link</th>
                </tr>
            </thead>
            <tbody>

                {% for report in reports %}
                    <tr>
                        <td>{{report.sample}}</td>
                        <td>{{report.family}}</td>
                        <td>{{report.ext_participant}}</td>
                        <td>{{report.ext_sample}}</td>
                        <td>{{report.report_type}}</td>
                        <td>{{report.run_date}}</td>
                        <td>{{report.missing}}</td>
                        <td>
                            {% if report.loci_of_interest %}
                            <div class="loci-cell">
                                {% for color, loci in report.loci_of_interest.items() %}
                                {% for locus in loci %}
                                <span style="background-color: {{color}}; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block;">{{locus}}</span>
                                {% endfor %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        <td><button onclick="window.open('{{report.url}}', '_blank')" style="background-color: #90EE90; border: none; border-radius: 8px; padding: 4px 12px;">Open</button></td>
                    </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.widgets.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function() {

        // Tablesorter: configure report table
        $("#report-table").tablesorter({
          theme : "bootstrap",
          sortList : [[0,0]],
          widgets : ["zebra", "filter", "columns"],
          widgetOptions : {
            columns: ["", ""],
          }
        })

        // Add click handler to reveal blurred loci cells
        $(".loci-cell").click(function() {
          $(this).toggleClass("revealed");
        });
      })
      function toggleTableVisibility() {
        const tableContainer = document.getElementById('lociTableContainer');
        const button = document.getElementById('toggleButton');

          if (tableContainer.style.display === 'none') {
              // Show the table
              tableContainer.style.display = 'block';
              // Change button text to Hide
              button.textContent = 'Hide Report Loci Reference Table';
          } else {
              // Hide the table
              tableContainer.style.display = 'none';
              // Change button text to Show
              button.textContent = 'Show Report Loci Reference Table';
          }
      }
    </script>
  </body>
</html>
