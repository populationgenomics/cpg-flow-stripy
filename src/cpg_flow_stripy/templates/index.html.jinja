<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{dataset}} Reports Dashboard</title>
    <meta name="description" content="{{dataset}} Reports Dashboard">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/widget.grouping.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.bootstrap_4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <style type="text/css">
      a {text-decoration: none;}
      .group-name {font-weight: normal;}
      .description {
            text-align: center;
            display: block;
            margin: auto;
        }
        .container {
            max-width: 80vw;
            display: block;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loci-cell {
            cursor: pointer;
            transition: all 0.3s ease;
            height: 30px;
            width: 120px;
            display: inline-block;
            background-color: #888;
            padding: 4px;
            border-radius: 4px;
            color: transparent;
            overflow: hidden;
        }
        .loci-cell * {
            visibility: hidden;
        }
        .loci-cell.revealed {
            background-color: transparent;
            color: inherit;
            height: auto;
            width: auto;
            overflow: visible;
        }
        .loci-cell.revealed * {
            visibility: visible;
        }
        .loci-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .loci-btn {
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
        }
        .loci-btn-hide {
            background-color: #6c757d;
            color: white;
        }
        .loci-btn-hide:hover {
            background-color: #5a6268;
        }
        .loci-btn-warning {
            background-color: #dc3545;
            color: white;
        }
        .loci-btn-warning:hover {
            background-color: #c82333;
        }
        .loci-column-hidden {
            display: none;
        }
        .loci-filter-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            font-size: 14px;
            min-width: 200px;
            height: auto;
        }
        .loci-filter-hidden {
            display: none !important;
        }
        .loci-filter-container {
            position: relative;
            display: inline-block;
        }
        .loci-filter-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            background-color: white;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
            text-align: left;
        }
        .loci-filter-btn:after {
            content: '▼';
            float: right;
            margin-left: 10px;
        }
        .loci-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 8px;
            min-width: 200px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loci-filter-dropdown.show {
            display: block;
        }
        .loci-filter-dropdown label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            margin: 0;
        }
        .loci-filter-dropdown label:hover {
            background-color: #f0f0f0;
        }
        .loci-filter-dropdown input[type="checkbox"] {
            margin-right: 8px;
        }

    </style>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-dark justify-content-start">
      <a class="navbar-brand p-3" href="#">{{dataset}} Reports Dashboard</a>
    </nav>

    <div class="container">
        <div class="description">
            <p>Explore STRipy reports organised by Sample and Family IDs, Report Type, and Missing Loci.</p>
            <p>Click "Open" to view individual detailed reports</p>
            <p> Note: The "Missing loci" column shows loci present in the panel for the given Report Type, but absent from
            the variant data for a sample. This can happen when a sample was processed before a locus was added to the
            STRipy catalogue. These samples can be re-genotyped on request, which will capture all current loci.
            </p>
        </div>

        <div style="text-align: center;">
            <button id="toggleButton" onclick="toggleTableVisibility()" style="background-color: #90EE90; border: none; border-radius: 8px; padding: 8px 16px;">
                Show Report Loci Reference Table
            </button>
        </div>

        <br>

        <div id="lociTableContainer" style="display: none;">
            <table class="table tablesorter" id="loci-table">
                <thead>
                    <tr>
                        <th>Report Type</th>
                        <th>Total Loci</th>
                        <th>Full Loci List</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Default</strong></td>
                        <td>62</td>
                        <td>ABCD3, AFF2, AR, ARX_1, ARX_2, ATN1, ATXN1, ATXN10, ATXN2, ATXN3, ATXN7, ATXN8OS, BEAN1, C9ORF72, CACNA1A, CBL, CNBP, COMP, CSTB, DAB1, DIP2B, DMD, DMPK, EIF4A3, FGF14, FMR1, FOXL2, FXN, GIPC1, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, HTT, JPH3, LRP12, MARCHF6, NOP56, NOTCH2NLC, NUTM2B-AS1, PABPN1, PHOX2B, PPP2R2B, PRDM12, PRNP, RAPGEF2, RILPL1, RUNX2, SAMD12, SOX3, STARD7, TBP, TBX1, TCF4, THAP11, TNRC6A, VWA1, XYLT1, YEATS2, ZFHX3, ZIC2, ZIC3</td>
                    </tr>
                    <tr>
                        <td><strong>Default with exclusions</strong></td>
                        <td>59</td>
                       <td>The same list as default, but excludes C9ORF72, HTT, and PRNP</td>
                    </tr>

                    <tr>
                        <td><strong>Paediatric</strong></td>
                        <td>31</td>
                        <td>AFF2, ARX_2, ATXN2, ATXN3, ATXN7, CBL, COMP, CSTB, DIP2B, DMD, DMPK, EIF4A3, FMR1, FOXL2, FXN, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, PHOX2B, PPP2R2B, PRDM12, RUNX2, SOX3, TBP, TBX1, VWA1, XYLT1, ZIC2, ZIC3</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <main class="container mt-4 mb-4">

    <div class="loci-controls">
        <button id="toggleLociColumn" class="loci-btn loci-btn-hide" onclick="toggleLociColumn()">
            Show Loci of Interest
        </button>
        <button id="toggleBlurBtn" class="loci-btn loci-btn-warning" onclick="toggleBlurAllLoci()">
            Unblur All Loci
        </button>
        <div id="locusFilterContainer" class="loci-filter-container loci-filter-hidden">
            <button type="button" class="loci-filter-btn" onclick="toggleFilterDropdown()">
                Hide Loci...
            </button>
            <div id="locusFilterDropdown" class="loci-filter-dropdown">
            </div>
        </div>
    </div>

    <div class="tab-pane fade show active" id="results-tab-pane" role="tabpanel" tabindex="0">
        <table class="table tablesorter" id="report-table">
            <thead>
                <tr>
                <th class="group-false">Sample</th>
                <th class="group-false">Family</th>
                <th class="group-false">Ext.ID</th>
                <th class="group-false">Ext.Sample</th>
                <th class="group-false">Report Type</th>
                <th class="group-false sorter-shortDate" data-date-format="yyyy-mm-dd">Date</th>
                <th class="group-false">Missing Loci</th>
                <th class="group-false loci-column loci-column-hidden">Loci of Interest</th>
                <th class="group-false">Link</th>
                </tr>
            </thead>
            <tbody>

                {% for report in reports %}
                    <tr>
                        <td>{{report.sample}}</td>
                        <td>{{report.family}}</td>
                        <td>{{report.ext_participant}}</td>
                        <td>{{report.ext_sample}}</td>
                        <td>{{report.report_type}}</td>
                        <td>{{report.run_date}}</td>
                        <td>{{report.missing}}</td>
                        <td class="loci-column loci-column-hidden">
                            <div class="loci-cell">
                                {% if report.loci_of_interest %}
                                {% for color, loci in report.loci_of_interest.items() %}
                                {% for locus in loci %}
                                <span class="locus-tag" data-locus="{{locus}}" style="background-color: {{color}}; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block;">{{locus}}</span>
                                {% endfor %}
                                {% endfor %}
                                {% else %}
                                <span style="color: #ccc;">—</span>
                                {% endif %}
                            </div>
                        </td>
                        <td><button onclick="window.open('{{report.url}}', '_blank')" style="background-color: #90EE90; border: none; border-radius: 8px; padding: 4px 12px;">Open</button></td>
                    </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.widgets.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function() {

        // Tablesorter: configure report table
        $("#report-table").tablesorter({
          theme : "bootstrap",
          sortList : [[0,0]],
          widgets : ["zebra", "filter", "columns"],
          widgetOptions : {
            columns: ["", ""],
          }
        })

        // Hide the filter cell for loci column (index 7) on load since column starts hidden
        setTimeout(function() {
          const filterRow = document.querySelector('#report-table .tablesorter-filter-row');
          if (filterRow && filterRow.cells[7]) {
            filterRow.cells[7].style.display = 'none';
          }
        }, 100);

        // Add click handler to reveal blurred loci cells
        $(".loci-cell").click(function() {
          $(this).toggleClass("revealed");
          updateBlurButtonState();
        });

        // Populate the locus filter dropdown with unique loci and their counts
        populateLocusFilter();
      })

      function updateBlurButtonState() {
        const cells = document.querySelectorAll('.loci-cell');
        const button = document.getElementById('toggleBlurBtn');
        const anyRevealed = Array.from(cells).some(cell => cell.classList.contains('revealed'));
        button.textContent = anyRevealed ? 'Re-blur All Loci' : 'Unblur All Loci';

        // Update filter dropdown visibility
        updateFilterVisibility();
      }

      function updateFilterVisibility() {
        const cells = document.querySelectorAll('.loci-cell');
        const columns = document.querySelectorAll('.loci-column');
        const filterContainer = document.getElementById('locusFilterContainer');

        const allRevealed = Array.from(cells).every(cell => cell.classList.contains('revealed'));
        const columnVisible = !columns[0].classList.contains('loci-column-hidden');

        // Show filter only when column is visible AND all cells are revealed
        if (allRevealed && columnVisible) {
          filterContainer.classList.remove('loci-filter-hidden');
        } else {
          filterContainer.classList.add('loci-filter-hidden');
        }
      }

      function populateLocusFilter() {
        const locusCounts = {};

        // Count occurrences of each locus
        document.querySelectorAll('.locus-tag').forEach(tag => {
          const locus = tag.dataset.locus;
          if (locus) {
            locusCounts[locus] = (locusCounts[locus] || 0) + 1;
          }
        });

        // Sort loci alphabetically
        const sortedLoci = Object.keys(locusCounts).sort();

        // Add checkboxes to the dropdown
        const dropdown = document.getElementById('locusFilterDropdown');
        sortedLoci.forEach(locus => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = locus;
          checkbox.onchange = filterByLocus;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(`${locus} (${locusCounts[locus]})`));
          dropdown.appendChild(label);
        });
      }

      function toggleFilterDropdown() {
        const dropdown = document.getElementById('locusFilterDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const container = document.getElementById('locusFilterContainer');
        if (container && !container.contains(event.target)) {
          document.getElementById('locusFilterDropdown').classList.remove('show');
        }
      });

      function filterByLocus() {
        const checkboxes = document.querySelectorAll('#locusFilterDropdown input[type="checkbox"]:checked');
        const selectedLoci = Array.from(checkboxes).map(cb => cb.value);
        const locusTags = document.querySelectorAll('.locus-tag');

        locusTags.forEach(tag => {
          if (selectedLoci.includes(tag.dataset.locus)) {
            tag.style.display = 'none';
          } else {
            tag.style.display = 'inline-block';
          }
        });
      }

      function toggleTableVisibility() {
        const tableContainer = document.getElementById('lociTableContainer');
        const button = document.getElementById('toggleButton');

          if (tableContainer.style.display === 'none') {
              // Show the table
              tableContainer.style.display = 'block';
              // Change button text to Hide
              button.textContent = 'Hide Report Loci Reference Table';
          } else {
              // Hide the table
              tableContainer.style.display = 'none';
              // Change button text to Show
              button.textContent = 'Show Report Loci Reference Table';
          }
      }

      function toggleLociColumn() {
        const columns = document.querySelectorAll('.loci-column');
        const filterRow = document.querySelector('#report-table .tablesorter-filter-row');
        const button = document.getElementById('toggleLociColumn');
        const isHidden = columns[0].classList.contains('loci-column-hidden');

        columns.forEach(col => {
          if (isHidden) {
            col.classList.remove('loci-column-hidden');
          } else {
            col.classList.add('loci-column-hidden');
          }
        });

        // Also hide/show the filter input for the loci column (index 7)
        if (filterRow) {
          const filterCell = filterRow.cells[7];
          if (filterCell) {
            filterCell.style.display = isHidden ? '' : 'none';
          }
        }

        button.textContent = isHidden ? 'Hide Loci of Interest' : 'Show Loci of Interest';

        // Update filter dropdown visibility
        updateFilterVisibility();
      }

      function toggleBlurAllLoci() {
        const cells = document.querySelectorAll('.loci-cell');
        const button = document.getElementById('toggleBlurBtn');
        const anyRevealed = Array.from(cells).some(cell => cell.classList.contains('revealed'));

        if (anyRevealed) {
          // Re-blur all cells
          cells.forEach(cell => {
            cell.classList.remove('revealed');
          });
          button.textContent = 'Unblur All Loci';
        } else {
          // Unblur all cells with warning
          const confirmed = confirm('Warning: This will reveal all Loci of Interest data for all samples. Are you sure you want to continue?');
          if (confirmed) {
            cells.forEach(cell => {
              cell.classList.add('revealed');
            });
            button.textContent = 'Re-blur All Loci';
          }
        }

        // Update filter dropdown visibility
        updateFilterVisibility();
      }
    </script>
  </body>
</html>
