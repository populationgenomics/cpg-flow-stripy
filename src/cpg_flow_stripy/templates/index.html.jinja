<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{dataset}} Reports Dashboard</title>
    <meta name="description" content="{{dataset}} Reports Dashboard">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/widget.grouping.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.bootstrap_4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <style type="text/css">
      a {text-decoration: none;}
      .group-name {font-weight: normal;}
      td, th {text-align: left; vertical-align: top;}
      .description {
            text-align: center;
            display: block;
            margin: auto;
        }
        .container {
            max-width: 80vw;
            display: block;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loci-cell {
            cursor: pointer;
            transition: all 0.3s ease;
            height: 30px;
            width: 120px;
            display: inline-block;
            background-color: #888;
            padding: 4px;
            border-radius: 4px;
            color: transparent;
            overflow: hidden;
        }
        .loci-cell * {
            visibility: hidden;
        }
        .loci-cell.revealed {
            background-color: transparent;
            color: inherit;
            height: auto;
            width: auto;
            overflow: visible;
        }
        .loci-cell.revealed * {
            visibility: visible;
        }
        .loci-column-hidden {
            display: none;
        }
        .d-none {
            display: none !important;
        }

      /* Center only the Link column in the report-table */
      #report-table th:nth-child(9), #report-table td:nth-child(9) {
        text-align: center;
      }

      /* Hide the blur/unblur button when loci column is hidden */
      .blur-btn-hidden {
        display: none !important;
      }

    </style>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-dark justify-content-start">
      <a class="navbar-brand p-3" href="#">{{dataset}} Reports Dashboard</a>
    </nav>

    <div class="container">
        <div class="description">
            <p>Explore STRipy reports organised by Sample and Family IDs, Report Type, and Missing Loci.</p>
            <p>Click "Open" to view individual detailed reports</p>
            <p>
              <strong>Loci of Interest</strong> is a hidden column that can be shown using the button below. It displays flagged loci for each sample, with color indicating significance:
              <br><span style="color:#ff6b6b;">Red</span> – Pathogenic, <span style="color:#ffd93d;">Orange</span> – Intermediate, <span style="color:#e599f7;">Pink</span> – One Hit AR, <span style="color:#ccc;">Grey</span> – Unknown/Outlier.
              <br>Cells are blurred by default for privacy; click a cell to reveal it. Use the Unblur All button (with warning) to reveal all. A filter dropdown lets you hide specific loci, and appears only when the column is visible and all cells are unblurred.
            </p>
            <p> Note: The "Missing loci" column shows loci present in the panel for the given Report Type, but absent from
            the variant data for a sample. This can happen when a sample was processed before a locus was added to the
            STRipy catalogue. These samples can be re-genotyped on request, which will capture all current loci.
            </p>
        </div>

        <div style="text-align: center;">
            <button id="toggleButton" class="btn btn-success" onclick="toggleTableVisibility()">
                Show Report Loci Reference Table
            </button>
        </div>

        <br>

        <div id="lociTableContainer" style="display: none;">
            <table class="table tablesorter" id="loci-table">
                <thead>
                    <tr>
                        <th>Report Type</th>
                        <th>Total Loci</th>
                        <th>Full Loci List</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Default</strong></td>
                        <td>62</td>
                        <td>ABCD3, AFF2, AR, ARX_1, ARX_2, ATN1, ATXN1, ATXN10, ATXN2, ATXN3, ATXN7, ATXN8OS, BEAN1, C9ORF72, CACNA1A, CBL, CNBP, COMP, CSTB, DAB1, DIP2B, DMD, DMPK, EIF4A3, FGF14, FMR1, FOXL2, FXN, GIPC1, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, HTT, JPH3, LRP12, MARCHF6, NOP56, NOTCH2NLC, NUTM2B-AS1, PABPN1, PHOX2B, PPP2R2B, PRDM12, PRNP, RAPGEF2, RILPL1, RUNX2, SAMD12, SOX3, STARD7, TBP, TBX1, TCF4, THAP11, TNRC6A, VWA1, XYLT1, YEATS2, ZFHX3, ZIC2, ZIC3</td>
                    </tr>
                    <tr>
                        <td><strong>Default with exclusions</strong></td>
                        <td>59</td>
                       <td>The same list as default, but excludes C9ORF72, HTT, and PRNP</td>
                    </tr>

                    <tr>
                        <td><strong>Paediatric</strong></td>
                        <td>31</td>
                        <td>AFF2, ARX_2, ATXN2, ATXN3, ATXN7, CBL, COMP, CSTB, DIP2B, DMD, DMPK, EIF4A3, FMR1, FOXL2, FXN, GLS, HOXA13_1, HOXA13_2, HOXA13_3, HOXD13, PHOX2B, PPP2R2B, PRDM12, RUNX2, SOX3, TBP, TBX1, VWA1, XYLT1, ZIC2, ZIC3</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <main class="container mt-4 mb-4">

    <div class="d-flex justify-content-center gap-2 mb-3">
        <button id="toggleLociColumn" class="btn btn-secondary" onclick="toggleLociColumn()">
            Show Loci of Interest
        </button>
        <button id="toggleBlurBtn" class="btn btn-danger" onclick="toggleBlurAllLoci()">
            Unblur All Loci
        </button>
        <div id="locusFilterContainer" class="dropdown d-none">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Hide Loci...
            </button>
            <ul id="locusFilterDropdown" class="dropdown-menu" style="max-height: 250px; overflow-y: auto;">
            </ul>
        </div>
    </div>

    <div class="tab-pane fade show active" id="results-tab-pane" role="tabpanel" tabindex="0">
        <table class="table tablesorter" id="report-table">
            <thead>
                <tr>
                <th class="group-false">Sample</th>
                <th class="group-false">Family</th>
                <th class="group-false">Ext.ID</th>
                <th class="group-false">Ext.Sample</th>
                <th class="group-false">Affected Status</th>
                <th class="group-false">Report Type</th>
                <th class="group-false sorter-shortDate" data-date-format="yyyy-mm-dd">Date</th>
                <th class="group-false">Missing Loci</th>
                <th class="group-false loci-column loci-column-hidden">Loci of Interest</th>
                <th class="group-false">Link</th>

                </tr>
            </thead>
            <tbody>

                {% for report in reports %}
                    <tr>
                        <td>{{report.sample}}</td>
                        <td>{{report.family}}</td>
                        <td>{{report.ext_participant}}</td>
                        <td>{{report.ext_sample}}</td>
                        <td>{{report.affected_status}}</td>
                        <td>{{report.report_type}}</td>
                        <td>{{report.run_date}}</td>
                        <td>{{report.missing}}</td>
                        <td class="loci-column loci-column-hidden">
                            <div class="loci-cell">
                                {% if report.loci_of_interest %}
                                {% for color, loci in report.loci_of_interest.items() %}
                                {% for locus in loci %}
                                <span class="locus-tag" data-locus="{{locus}}" style="background-color: {{color}}; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block;">{{locus}}</span>
                                {% endfor %}
                                {% endfor %}
                                {% else %}
                                <span style="color: #ccc;">—</span>
                                {% endif %}
                            </div>
                        </td>
                        <td><button class="btn btn-success btn-sm" onclick="window.open('{{report.url}}', '_blank')">Open</button></td>

                    </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.widgets.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function() {

        // Tablesorter: configure report table
        $("#report-table").tablesorter({
          theme : "bootstrap",
          sortList : [[0,0]],
          widgets : ["zebra", "filter", "columns"],
          widgetOptions : {
            columns: ["", ""],
          }
        })

        // Hide the filter cell for loci column (index 7) on load since column starts hidden
        setTimeout(function() {
          const filterRow = document.querySelector('#report-table .tablesorter-filter-row');
          if (filterRow && filterRow.cells[7]) {
            filterRow.cells[7].style.display = 'none';
          }
        }, 100);

        // Add click handler to reveal blurred loci cells
        $(".loci-cell").click(function() {
          $(this).toggleClass("revealed");
          updateBlurButtonState();
        });

        // Populate the locus filter dropdown with unique loci and their counts
        populateLocusFilter();

        // Hide the blur/unblur button if loci column is hidden on load
        const lociColumns = document.querySelectorAll('.loci-column');
        const blurBtn = document.getElementById('toggleBlurBtn');
        if (lociColumns.length && lociColumns[0].classList.contains('loci-column-hidden') && blurBtn) {
          blurBtn.classList.add('blur-btn-hidden');
        }
      })

      function updateBlurButtonState() {
        const cells = document.querySelectorAll('.loci-cell');
        const button = document.getElementById('toggleBlurBtn');
        const anyRevealed = Array.from(cells).some(cell => cell.classList.contains('revealed'));
        button.textContent = anyRevealed ? 'Re-blur All Loci' : 'Unblur All Loci';

        // Update filter dropdown visibility
        updateFilterVisibility();
      }

      function updateFilterVisibility() {
        const cells = document.querySelectorAll('.loci-cell');
        const columns = document.querySelectorAll('.loci-column');
        const filterContainer = document.getElementById('locusFilterContainer');

        const allRevealed = Array.from(cells).every(cell => cell.classList.contains('revealed'));
        const columnVisible = !columns[0].classList.contains('loci-column-hidden');

        // Show filter only when column is visible AND all cells are revealed
        if (allRevealed && columnVisible) {
          filterContainer.classList.remove('d-none');
        } else {
          filterContainer.classList.add('d-none');
        }
      }

      function populateLocusFilter() {
        const locusCounts = {};

        // Count occurrences of each locus
        document.querySelectorAll('.locus-tag').forEach(tag => {
          const locus = tag.dataset.locus;
          if (locus) {
            locusCounts[locus] = (locusCounts[locus] || 0) + 1;
          }
        });

        // Sort loci alphabetically
        const sortedLoci = Object.keys(locusCounts).sort();

        // Add checkboxes to the dropdown using Bootstrap list items
        const dropdown = document.getElementById('locusFilterDropdown');
        sortedLoci.forEach(locus => {
          const li = document.createElement('li');
          const label = document.createElement('label');
          label.className = 'dropdown-item';
          label.style.cursor = 'pointer';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'form-check-input me-2';
          checkbox.value = locus;
          checkbox.onchange = filterByLocus;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(`${locus} (${locusCounts[locus]})`));
          li.appendChild(label);
          dropdown.appendChild(li);
        });
      }

      function filterByLocus() {
        const checkboxes = document.querySelectorAll('#locusFilterDropdown input[type="checkbox"]:checked');
        const selectedLoci = Array.from(checkboxes).map(cb => cb.value);
        const locusTags = document.querySelectorAll('.locus-tag');

        locusTags.forEach(tag => {
          if (selectedLoci.includes(tag.dataset.locus)) {
            tag.style.display = 'none';
          } else {
            tag.style.display = 'inline-block';
          }
        });
      }

      function toggleTableVisibility() {
        const tableContainer = document.getElementById('lociTableContainer');
        const button = document.getElementById('toggleButton');

          if (tableContainer.style.display === 'none') {
              // Show the table
              tableContainer.style.display = 'block';
              // Change button text to Hide
              button.textContent = 'Hide Report Loci Reference Table';
          } else {
              // Hide the table
              tableContainer.style.display = 'none';
              // Change button text to Show
              button.textContent = 'Show Report Loci Reference Table';
          }
      }

      function toggleLociColumn() {
        const columns = document.querySelectorAll('.loci-column');
        const filterRow = document.querySelector('#report-table .tablesorter-filter-row');
        const button = document.getElementById('toggleLociColumn');
        const blurBtn = document.getElementById('toggleBlurBtn');
        const isHidden = columns[0].classList.contains('loci-column-hidden');

        columns.forEach(col => {
          if (isHidden) {
            col.classList.remove('loci-column-hidden');
          } else {
            col.classList.add('loci-column-hidden');
          }
        });

        // Also hide/show the filter input for the loci column (index 7)
        if (filterRow) {
          const filterCell = filterRow.cells[7];
          if (filterCell) {
            filterCell.style.display = isHidden ? '' : 'none';
          }
        }

        button.textContent = isHidden ? 'Hide Loci of Interest' : 'Show Loci of Interest';

        // Hide/show the blur/unblur button
        if (blurBtn) {
          if (isHidden) {
            blurBtn.classList.remove('blur-btn-hidden');
          } else {
            blurBtn.classList.add('blur-btn-hidden');
          }
        }

        // Update filter dropdown visibility
        updateFilterVisibility();
      }

      function toggleBlurAllLoci() {
        const cells = document.querySelectorAll('.loci-cell');
        const button = document.getElementById('toggleBlurBtn');
        const anyRevealed = Array.from(cells).some(cell => cell.classList.contains('revealed'));

        if (anyRevealed) {
          // Re-blur all cells
          cells.forEach(cell => {
            cell.classList.remove('revealed');
          });
          button.textContent = 'Unblur All Loci';
        } else {
          // Unblur all cells with warning
          const confirmed = confirm('Warning: This will reveal all Loci of Interest data for all samples. Are you sure you want to continue?');
          if (confirmed) {
            cells.forEach(cell => {
              cell.classList.add('revealed');
            });
            button.textContent = 'Re-blur All Loci';
          }
        }

        // Update filter dropdown visibility
        updateFilterVisibility();
      }
    </script>
  </body>
</html>
